% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/plot_pdp.R
\name{plot_pdp}
\alias{plot_pdp}
\title{Create Partial Dependence Plot with Individual Conditional Expectation Lines}
\usage{
plot_pdp(
  data,
  model,
  response,
  x_var,
  x_var_title,
  verbose = FALSE,
  gridsize = 10,
  nmax = 500,
  nIce = 30,
  limits = NULL,
  colorVar = NULL,
  probability = FALSE,
  borders = "none",
  category_colors = NULL,
  category_alpha = 0.5,
  category_names = NULL,
  category_title = NULL,
  title = "Partial Dependence Plot with ICE Curves",
  subtitle = NULL,
  ice_alpha = 0.4,
  ice_linecolor = "lightgrey",
  ice_linewidth = 0.5,
  ice_pointsize = 3,
  pdp_linecolor = "#008080",
  pdp_linewidth = 0.5,
  cond_mean_linewidth = NULL,
  pdp_intervalcolor = "black",
  pdp_meancolor = "#008080",
  pdp_meanfill = "black",
  pdp_meanshape = 23,
  obs_color = "black",
  obs_shape = 4,
  show_observed = TRUE,
  ridgeline_scale = 0.8,
  ridgeline_color = "lightgrey",
  show_border_lines = TRUE,
  seed = 42,
  cond_color_var = NULL,
  cond_color_levels = NULL,
  cond_color_palette = NULL,
  cond_color_title = NULL,
  cond_color_legend_levels = NULL,
  cond_color_foreground = NULL,
  show_category_background = NULL
)
}
\arguments{
\item{data}{A data frame containing the predictor variables and the response.}

\item{response}{Character string. The name of the response variable in \code{data}.}

\item{x_var}{Character string specifying the name of the predictor variable to plot.}

\item{x_var_title}{Character string specifying x-axis title.}

\item{verbose}{Logical. If \code{TRUE}, returns a list with both data and plot.
If \code{FALSE} (default), returns only the plot.}

\item{gridsize}{Integer. Number of points to evaluate in the grid for each variable. Default is 10.}

\item{nmax}{Integer. Maximum number of observations sampled from \code{data} for computing
all ICE curves and the PDP mean. This controls computational cost and PDP accuracy.
All \code{nmax} observations are used to calculate the aggregated PDP curve. Default is 500.}

\item{nIce}{Integer or integer vector controlling which ICE curves to \strong{display} (sampled from the \code{nmax} computed curves).
If a single integer, specifies the number of ICE curves to randomly sample for visualization (default is 30).
If a vector of integers, specifies the exact row indices. This only affects visual clarity, not PDP computation.
Must not exceed \code{nmax}.}

\item{limits}{Optional numeric vector of y-axis limits. If \code{NULL}, computed from the data.}

\item{colorVar}{Optional variable name for colouring ICE curves (instead of prediction values).}

\item{probability}{Logical. Whether to use probability predictions. Default is \code{FALSE}.}

\item{borders}{Either a numeric vector of category borders or the string "auto" or "none".
If numeric vector, specifies the borders for category background mapping. If "auto" (default), uses
the model's category borders. If "none", no background mapping is shown.
Default is "auto".}

\item{category_colors}{Character vector of colors for category backgrounds.
If NULL, uses default color palette.}

\item{category_alpha}{Numeric value between 0 and 1 for category background transparency.
Default is 0.5.}

\item{category_names}{Character vector of category names for the legend.
If NULL, uses default names.}

\item{category_title}{Character vector of the legend title.
If NULL, no title is shown.}

\item{title}{Character string for the plot title. Default is "Partial Dependence Plot with ICE Curves".}

\item{subtitle}{Character string for the plot subtitle. Default is NULL (no subtitle).}

\item{ice_alpha}{Numeric value between 0 and 1 for ICE line transparency.
Default is 0.4.}

\item{ice_linecolor}{Character string specifying the color of ICE lines. Default is "purple".}

\item{ice_linewidth}{Numeric value for the width of ICE lines. Default is 0.7.}

\item{ice_pointsize}{Numeric value for the size of observed prodiction values. Default is 1.5.}

\item{pdp_linecolor}{Character string specifying the color of the PDP mean line.
Default is "black".}

\item{pdp_linewidth}{Numeric value for the width of the PDP mean line. Default is 1.5.}

\item{cond_mean_linewidth}{Numeric value for the width of the conditional PDP mean lines
when \code{cond_color_var} is specified. If \code{NULL} (default), uses the same value as
\code{pdp_linewidth}.}

\item{pdp_intervalcolor}{Character string specifying the color of the interval lines for the PDP mean.
Default is "black".}

\item{pdp_meancolor}{Character string specifying the color of the point's outline for the PDP mean.
Default is "black".}

\item{pdp_meanfill}{Character string specifying the fill color of the point for the PDP mean.
Default is "black".}

\item{pdp_meanshape}{Numeric value for the shape of the point for the PDP mean. Default is 16.}

\item{obs_color}{Character string for the color of observed prediction points. Default is "grey".}

\item{show_observed}{Logical. If \code{TRUE}, shows observed prediction points on the plot.
Default is \code{TRUE}. Note: Not applicable for categorical X with conditional coloring.}

\item{ridgeline_scale}{Numeric value controlling the height scaling of ridgeline
plots for categorical variables. Default is 0.8.}

\item{show_border_lines}{Logical. If \code{TRUE}, adds dashed lines at category borders.
For continuous X: horizontal lines at Y borders. For categorical X: vertical lines (due to coord_flip).
Works independently of \code{show_category_background}. Default is \code{TRUE}.}

\item{cond_color_var}{Character string specifying the name of a second predictor variable
to use for conditional coloring of ICE curves. When specified, ICE curves are colored by this
variable to explore potential interactions. Default is \code{NULL} (no conditional coloring).}

\item{cond_color_levels}{Character vector or named list specifying which levels/ranges to color.
For categorical variables: character vector of factor levels (if NULL, uses first 3-5 levels).
For continuous variables: named list where names are labels and values are numeric vectors of length 2
specifying ranges, e.g., \code{list("Low" = c(0, 5), "High" = c(5, 10))}.}

\item{cond_color_palette}{Character vector of colors to use for conditional coloring.
If NULL, uses a default color palette. Length should match number of conditioning levels/ranges.}

\item{cond_color_title}{Character string for the conditional color legend title.
If NULL, uses the variable name from \code{cond_color_var}.}

\item{cond_color_legend_levels}{Character vector specifying which levels to show in the legend.
Useful when many levels are plotted but only a subset should appear in the legend (e.g., highlighting
specific categories while others are shown in gray). If NULL (default), all levels from
\code{cond_color_levels} appear in the legend. Only applicable when \code{cond_color_var} is specified.}

\item{cond_color_foreground}{Character vector specifying the plotting order of conditioning variable
levels from back to front (first element plotted first/in background, last element plotted last/in foreground).
For categorical variables: provide a vector of level names in desired order.
For continuous variables: provide a vector of range names in desired order.
If only one value is provided, that level is plotted on top with others in default order underneath.
If NULL, default plotting order is used. Only applicable for continuous X with conditional coloring.}

\item{show_category_background}{Logical. Controls colored backgrounds/fills for category mapping:
\itemize{
  \item For continuous X: Shows colored background rectangles.
  \item For categorical X (unconditional): Controls density ridge fill coloring by category.
  \item For categorical X (conditional): Not applicable - densities are colored by conditioning variable.
}
Default is \code{TRUE} when \code{cond_color_var = NULL}, \code{FALSE} otherwise.}

\item{fit}{A fitted \code{ranger} model object.}
}
\value{
If \code{verbose = FALSE}, returns a ggplot object. If \code{verbose = TRUE},
 returns a list with elements:
 \item{plot}{The ggplot object}
 \item{data}{List containing ice_data and pdp_data tibbles}
 \item{variable_type}{Character indicating whether variable was treated as "categorical" or "continuous"}
}
\description{
This function creates partial dependence plots (PDP) with individual conditional
expectation (ICE) lines for ordinal random forest models. It automatically detects
whether the predictor variable is continuous or categorical and creates appropriate
visualizations. For continuous variables, it shows ICE lines with optional category
background mapping. For categorical variables, it creates ridgeline plots showing
the distribution of predictions for each category. test
}
\details{
The function uses a two-stage sampling approach for computational efficiency:
\enumerate{
 \item \strong{Computation stage}: Sample \code{nmax} observations and compute ICE curves for all of them.
  The PDP mean is calculated from all \code{nmax} curves, ensuring statistical accuracy.
 \item \strong{Visualization stage}: Sample \code{nIce} curves from the \code{nmax} computed curves
  to display in the plot, reducing visual clutter while maintaining accurate PDP estimates.
}
This design allows you to compute accurate PDP curves from a large sample (e.g., 500 observations)
while displaying only a subset (e.g., 30 curves) for clarity.

The function automatically detects the variable type based on the original data:
\itemize{
 \item \strong{Categorical treatment}: Variables are treated as categorical if they are
  factors, characters, or have 4 or fewer unique values. A warning is displayed
  when numeric variables are treated as categorical due to having few unique values.
 \item \strong{Continuous variables}: Creates a traditional PDP with ICE lines,
  PDP mean line, and optional category background mapping using the \code{borders} parameter.
 \item \strong{Categorical variables}: Creates ridgeline plots showing the
  distribution of ICE predictions for each category level, with PDP mean points.
 \item \strong{Conditional ICE plots}: When \code{cond_color_var} is specified, ICE curves
  are colored by a second predictor variable to explore potential interactions (as recommended
  by Strobl et al. 2024). For continuous x-variables, ICE lines are colored by the conditioning
  variable, and BOTH the overall PDP (marginal effect) and group-specific conditional partial
  dependence lines (c-PDPs) are displayed. The overall PDP shows the average effect across all
  groups, while c-PDPs show the mean effect within each conditioning group. Comparing these lines
  helps identify interactions. For categorical x-variables, separate density ridges are created
  for each combination of the x-variable and conditioning variable levels, with group-specific
  mean lines and points. By default, category background coloring is disabled when conditional
  coloring is active, showing only vertical lines at category borders.
}
}
\examples{
\dontrun{
# Basic usage - just get the plot
plot <- plot_pdp(
 data = dm_train_dummy,
 model = rf_ord_dummy,
 response = "score",
 x_var = "item01",
 x_var_title = "Item 01"
)

# Verbose usage - get plot, data, and variable type info
result <- plot_pdp(
 data = dm_train_dummy,
 model = rf_ord_dummy,
 response = "score",
 x_var = "item01",
 x_var_title = "Item 01",
 verbose = TRUE
)

print(result$plot)
head(result$data$ice_data)

# Conditional ICE plot with categorical conditioning variable
# Color ICE curves by gender to explore potential interactions
plot <- plot_pdp(
 data = dm_train_dummy,
 model = rf_ord_dummy,
 response = "score",
 x_var = "age",
 x_var_title = "Age",
 cond_color_var = "gender",
 cond_color_levels = c("Male", "Female"),  # Select specific levels
 cond_color_palette = c("#E69F00", "#56B4E9"),  # Custom colors
 cond_color_title = "Gender"
)

# Conditional ICE plot with continuous conditioning variable
# This displays group-specific conditional PDPs (c-PDPs) - the mean ICE curve
# within each income range, useful for detecting interactions
plot <- plot_pdp(
 data = dm_train_dummy,
 model = rf_ord_dummy,
 response = "score",
 x_var = "age",  # continuous X variable
 x_var_title = "Age",
 cond_color_var = "income",  # continuous conditioning variable
 cond_color_levels = list(
   "Low" = c(0, 30000),
   "Medium" = c(30000, 70000),
   "High" = c(70000, 150000)
 ),
 cond_color_palette = c("#d73027", "#fee090", "#4575b4"),
 cond_color_title = "Income Range"
)
# The plot shows:
# - ICE curves colored by income range
# - Overall PDP line (marginal effect across all groups)
# - Thicker conditional PDP lines (average effect within each income group)
# Differences between conditional PDPs indicate an interaction effect

# Conditional ICE plot with category background visible
plot <- plot_pdp(
 data = dm_train_dummy,
 model = rf_ord_dummy,
 response = "score",
 x_var = "age",
 x_var_title = "Age",
 cond_color_var = "gender",
 show_category_background = TRUE,  # Show colored background for categories
 borders = "auto"  # Use model's category borders
)

# Conditional ICE plot with specific level in foreground
plot <- plot_pdp(
 data = dm_train_dummy,
 model = rf_ord_dummy,
 response = "score",
 x_var = "age",
 x_var_title = "Age",
 cond_color_var = "gender",
 cond_color_levels = c("Male", "Female"),
 cond_color_foreground = "Female"  # Plot Female curves on top
)

# Conditional ICE plot with explicit plotting order
plot <- plot_pdp(
 data = dm_train_dummy,
 model = rf_ord_dummy,
 response = "score",
 x_var = "age",
 x_var_title = "Age",
 cond_color_var = "region",
 cond_color_levels = c("North", "South", "East", "West"),
 cond_color_foreground = c("North", "South", "East", "West")  # Explicit order: North in back, West on top
)

# Conditional ICE plot with selective legend display
# Useful when plotting many categories but only highlighting a few in the legend
# Example: Show all items in gray except specific ones of interest in color
items_of_interest <- c("authorization", "organization", "civilization")
all_items <- levels(dm_train$item)

# Create color palette: gray for most items, viridis colors for items of interest
color_palette <- rep("lightgray", length(all_items))
color_palette[all_items \%in\% items_of_interest] <- viridisLite::viridis(length(items_of_interest))

plot <- plot_pdp(
 data = dm_train_dummy,
 model = rf_ord_dummy,
 response = "score",
 x_var = "age",
 x_var_title = "Age",
 cond_color_var = "item",
 cond_color_levels = all_items,  # Plot all items
 cond_color_palette = color_palette,
 cond_color_legend_levels = items_of_interest,  # Only show items of interest in legend
 cond_color_title = "Selected Items"
)
}

}
